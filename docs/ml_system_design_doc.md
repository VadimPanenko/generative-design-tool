# ML System Design Doc
## Генеративный сервис для дизайнеров - MVP

*Дизайн-документ разработан на основе шаблона от [Reliable ML](https://github.com/rvenie/wsi_research_agent/blob/main/docs/ml_system_design_doc.md)*

---

## 1. Цели и предпосылки

### 1.1. Зачем идем в разработку продукта?

**Бизнес-цель:**

Создать AI-сервис для автоматической генерации иконок и графических материалов в корпоративном стиле, который:
- Сокращает время создания визуального контента с 2-3 часов до 20-40 минут
- Автоматически применяет корпоративный стиль и цвета из бренд-бука
- Снижает зависимость от внешних подрядчиков и специалистов 3D-моделирования

**Почему станет лучше от использования ML:**

| Аспект | Как сейчас | Как будет с AI-сервисом |
|--------|-----------|------------------------|
| Время создания | 2-3 часа ручной работы в 3D-редакторах | 1-4 минуты автоматической генерации |
| Навыки | Требуются навыки 3D-моделирования | Простое текстовое описание на русском |
| Стиль | Ручное согласование с бренд-буком | Автоматическое применение корп. стиля |
| Итерации | Множественные согласования | Быстрые правки через inpainting |
| Подрядчики | Высокие затраты на специалистов | Внутренний инструмент для типовых задач |

**Критерии успеха итерации:**

- Сокращение времени создания графики минимум на **70%**
- Положительная обратная связь от **60%+** дизайнеров
- Использование сервиса для **30%+** новых задач по созданию 3D-иконок
- Соответствие бренд-буку в **70%+** случаев без ручной доработки
- Снижение итераций согласования на **30%**

---

### 1.2. Бизнес-требования и ограничения

**Функциональные требования:**
- 3D изображения в PNG формате без фона, в корпоративной стилистике
- Генерация предметов, 3D значков, ассетов для интерфейсов и презентаций
- Время генерации 1024x1024px не более 4 минут
- Простой веб-интерфейс с промптами на русском языке
- Автоматическое применение корпоративных цветов

**Бизнес-ограничения:**
- Использование внутренних GPU-серверов с ограниченными ресурсами
- Все данные хранятся внутри корпоративной инфраструктуры
- Ограниченный бюджет на внешние вычислительные ресурсы

**Описание бизнес-процесса пилота:**

1. **Фаза тестирования** (1-2 месяца): 5-7 дизайнеров тестируют параллельно с традиционными методами
2. **Фаза расширения** (2-3 месяца): Доступ для всей дизайн-команды (15-20 человек)
3. **Оценка результатов**: Сравнение времени, анализ удовлетворенности, подсчет экономического эффекта

**Критерии успешного пилота:**
- Adoption rate ≥ 60% (регулярное использование)
- Качество: ≥ 70% соответствие бренд-буку
- NPS ≥ 40
- Экономия ~10 часов/неделю для пилотной группы

---

### 1.3. Что входит в скоуп проекта/итерации

**Входит в скоуп MVP:**

*Функциональность:*
- Генерация 3D-иконок по текстовому описанию
- Автоматическое обогащение промптов с учетом корпоративных гайдлайнов
- Применение корпоративных цветов
- Веб-интерфейс с базовым функционалом
- Dual prompting (T5 + CLIP)

*Технические аспекты:*
- Развертывание на GPU-серверах (A40)
- Интеграция FLUX.1-dev для генерации
- Интеграция DeepSeek-R1 / Qwen2.5 для обогащения промптов
- Документация разработки

**НЕ входит в скоуп MVP:**
- Inpainting, upscaling, удаление фона
- Хранение истории промптов
- Плагин для Figma
- Генерация русскоязычного текста на изображениях
- Файн-тюнинг моделей на корпоративных данных
- RAG-система для промптов
- API для интеграции с другими системами
- Batch-генерация

---

### 1.4. Предпосылки решения

**Выбор блоков данных:**

1. **Корпоративные гайдлайны**: Цветовая палитра, стилистические требования, примеры 3D-иконок
   - *Обоснование*: Необходимы для автоматического применения корпоративного стиля

2. **История промптов и изображений**: Промпты пользователей, сгенерированные изображения, оценки качества
   - *Обоснование*: Анализ эффективности, накопление базы успешных промптов

3. **Обратная связь**: Оценки соответствия бренд-буку, комментарии, метрики использования
   - *Обоснование*: Критична для итеративного улучшения системы

**Технологический стек:**

| Компонент | Решение | Обоснование |
|-----------|---------|-------------|
| Генеративная модель | FLUX.1-dev | State-of-the-art качество, хорошее понимание промптов, возможность кастомизации |
| LLM для промптов | DeepSeek-R1 / Qwen2.5 | Поддержка русского языка, быстрая обработка |
| Инфраструктура | GPU NVIDIA A40 (48GB) | Требования безопасности, достаточные ресурсы |
| Backend/Frontend | FastAPI + веб-интерфейс | Быстрая разработка, легкая интеграция с ML |

**Гранулярность и горизонт:**
- Real-time генерация по запросу
- Одно изображение за один промпт
- Персонализация на уровне пользователя

**Предположения о поведении пользователей:**
- Формулировка запросов на русском в свободной форме
- 3-5 генераций за сессию с итеративными улучшениями
- Основной use-case: отдельные иконки, не сложные сцены

---

## 2. Методология

### 2.1. Постановка задачи

**Техническая формулировка:**

Разработка **генеративной системы text-to-image** с автоматическим стиль-адаптером для создания графических материалов в корпоративном стиле.

**Компоненты задачи:**

1. **Text-to-Image генерация**: Преобразование текста на русском в текс на изображениях
2. **Автоматическое обогащение промптов**: NLP-обработка через LLM, добавление стилистических параметров, перевод на английский, генерация negative prompts
3. **Оркестрация пайплайна**: Управление последовательностью вызовов моделей, обработка результатов

**Типы задач:**
- Основная: Условная генерация изображений
- Вспомогательная: Улучшение текста

**Метрики оценки:**
- **Технические**: Время генерации, использование GPU, throughput
- **Качественные**: CLIP score, соответствие бренд-буку (экспертная оценка)
- **Бизнес**: Процент использования, удовлетворенность, экономия времени

---

### 2.2. Схема решения



---

### 2.3. Этапы решения задачи

**Этап 1 - Подготовка данных**

**Цель**: Обеспечить наличие всех необходимых данных для работы системы.

**Данные:**

| Название | Источник | Статус |
|----------|----------|--------|
| Корпоративный бренд-бук | Figma, внутренние документы | ✓ |
| Примеры 3D-иконок | Библиотека дизайна Figma | ✓ |
| Предобученные FLUX.1-dev | HuggingFace | ✓ |
| LLM модели | Внутренний Model Hub | ✓ |
| Тестовые промпты | Встречи с дизайнерами | ✓ |

**Результат**: Все модели загружены на GPU-серверы, подготовлен набор из 50+ тестовых промптов.

---

**Этап 2 - Пайплайн обогащения промптов**

**Цель**: Разработать систему автоматического улучшения пользовательских запросов.

**Техническое решение:**
- FastAPI сервис с REST API endpoints (`/enrich_prompt`, `/negative_prompt_maker`, `/clip_prompt_maker`)
- Промпт-шаблоны для LLM с четкими требованиями (3D render, корп. цвета, стиль)
- DeepSeek-R1 для сложных промптов, Qwen2.5 для быстрых операций

**Метрики качества:**
- Время обработки < 3 секунд
- "Улучшенный промпт лучше" в 70%+ случаев (экспертная оценка)
- Наличие корпоративных цветов в 100% промптов

**Риски и митигации:**
- Риск: LLM галлюцинирует → Митигация: Строгие промпт-шаблоны
- Риск: Искажение перевода → Митигация: Словарь корпоративных терминов

---

**Этап 3 - Генерация изображений**

**Цель**: Стабильная генерация изображений высокого качества.

**Конфигурация FLUX.1-dev:**
```python
flux_config = {
    "num_inference_steps": 28,
    "guidance_scale": 3.5,
    "height": 1024,
    "width": 1024,
    "prompt": clip_optimized_prompt,
    "prompt_2": t5_detailed_prompt,
}
```

**Метрики качества:**

*Технические:*
- 512x512: < 30 сек
- 1024x1024: < 4 мин
- 2048x2048: < 10 мин

*Качественные:*
- Экспертная оценка: соответствие бренд-буку в 70%+ случаев
- Пользовательская оценка: > 60% "нравится"

**Риски:**
- FLUX не всегда генерирует 3D-стиль → Усиление keywords ("3D render", "isometric")
- Медленная генерация → Индикатор прогресса, 4-bit версия, переход на H100

---

**Этап 4 - Веб-интерфейс**

**Цель**: Создать удобный интерфейс для взаимодействия с системой.

**Архитектура:**
- Backend: FastAPI
- Frontend: Веб-интерфейс с формой ввода, превью, историей

**API Endpoints:**
```
POST /generate - Базовая генерация
GET /history - История генераций
```

**Метрики:**
- Отклик UI < 100ms
- Uptime > 90%
- Время до первой генерации < 2 минуты

---

**Этап 5 - Тестирование и пилот**

**Виды тестирования:**
1. Unit тесты: API endpoints, валидация
2. Integration тесты: Полный пайплайн
3. UAT: Тестирование с пилотной группой

**Критерии готовности:**
- ✓ Success rate > 90%
- ✓ Время генерации соответствует метрикам
- ✓ UI/UX протестирован
- ✓ Документация готова

**Метрики успеха пилота:**
- Adoption > 60%
- NPS > 40
- Качество > 70%
- Efficiency: сокращение времени на 70%+

---

## 3. Подготовка пилота

### 3.1. Способ оценки пилота

**Дизайн пилота:**

*Этап 1 - Контролируемое тестирование (1-2 месяца):*
- 5-7 дизайнеров, параллельное использование, еженедельные синхронизации

*Этап 2 - Расширенное тестирование (2-3 месяца):*
- 15-20 человек, свободное использование, ежемесячные опросы

**Метрики сбора данных:**

1. **Автоматические**: Количество пользователей, генераций, время, success rate, retention
2. **Качественные**: NPS, Satisfaction Score (1-5), Ease of Use (1-5), Time Savings
3. **Экспертная**: 50 изображений/месяц - оценка арт-директором
4. **Эффективность**: Измерение времени до/после внедрения

---

### 3.2. Критерии успешного пилота

**Обязательные критерии:**

| Категория | Метрика | Целевое значение |
|-----------|---------|------------------|
| Adoption | Регулярное использование | ≥ 60% |
| Quality | Соответствие бренд-буку | ≥ 70% |
| Quality | Satisfaction Score | > 3.5/5 |
| Efficiency | Время генерации 1024x1024 | < 4 мин |
| Efficiency | Сокращение времени | ≥ 70% |
| Satisfaction | NPS | ≥ 40 |
| Stability | Success rate | > 95% |
| Stability | Uptime | > 95% |

**Критерии неудачи:** Adoption < 40%, Качество < 40%, NPS < 0, Экономия < 40%

---

### 3.3. Подготовка пилота

**Текущая инфраструктура:**
- GPU: NVIDIA A40 (48GB)
- Количество: 2 сервера
- Пропускная способность: 20-30 генераций/час

**Ожидаемая нагрузка:**
- Пилотная группа: 5-7 пользователей
- Среднее использование: 3-5 генераций/день/пользователь
- Пиковая нагрузка: 10-15 генераций/час
- **Вывод**: Текущих ресурсов достаточно

**Ограничения:**
1. Не более 3 одновременных генераций (Queue FIFO)
2. Макс. разрешение 2048x2048
3. Хранение результатов 6 месяцев

**Параметры пилота:**
- Длительность: 3 месяца
- Группа: 5-7 → 15-20 человек
- Контрольные точки: Еженедельные → Ежемесячные
- Финальная оценка: Go/No-Go решение

---

## 4. Внедрение

> **Примечание**: Раздел заполняется на следующих итерациях для production системы.

**Текущая архитектура MVP:**
- Deployment: Monolithic application на одном сервере
- Доступ: Внутренний URL через корпоративную сеть
- Интеграции: Пока отсутствуют
- Мониторинг: Базовые логи
- Безопасность: Корпоративная аутентификация

**Планы на production (v2.0):**
- Микросервисная архитектура (LLM Service, Image Generation, API Gateway, Storage)
- Kubernetes оркестрация
- Public API
- Продвинутый мониторинг (Prometheus + Grafana)
- A/B тестирование моделей

---

## Заключение

Дизайн-документ описывает MVP генеративного сервиса для создания 3D-иконок в корпоративном стиле.

**Ключевые особенности:**
- Интеграция корпоративных гайдлайнов на уровне промпт-инженеринга
- Автоматическое применение корпоративного стиля
- Генерация предметов, 3D значков, ассетов для интерфейсов и презентаций компании

**Ожидаемый эффект:**
- Сокращение времени на 70-80%
- Повышение единообразия стиля на 60-70%
- Снижение зависимости от подрядчиков

**Следующие шаги:**
1. Завершение пилота (2-3 месяца)
2. Go/No-Go решение
3. Масштабирование на всю команду
4. Развитие функций (Figma-плагин, RAG, файн-тюнинг)
